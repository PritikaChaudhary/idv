<style type="text/css">
  .detail_div
  {
    margin-bottom: 25px;
    display: none;
  }

  .info
  {
    width : 40%;
    float: left;
    font-size: 12px;
  }

  .info_equal
  {
    width : 6%;
    float: left;
    font-size: 12px;
  }


  .info_detail
  {
    width : 54%;
    float: left;
    font-size: 12px;
  }
  .full_info
  {
    width: 100% !important;
    float:left;
  }
  .bordr_detail_div
  {
    /*border: 1px solid;*/
  }
  .sub_input
  {
    height:26px !important; 
    padding:0px !important; 
    width:134px !important;
    padding-left: 5px !important;
  }
  .ui-datepicker-header
  {
    background-color: #fff;
  }
  .ui-datepicker-prev
  {
    background:#eeeeee;
    margin-left: 2px;
  }
  .ui-datepicker-next
  {
    background:#eeeeee;
    margin-left:2px;
  }
  .side_fields
  {
    padding-left: 0px !important;
  }
  .crsr
  {
      cursor: all-scroll;
  }
  .analysis_form input
  {
    margin: 0px !important;
  }
  .analysis_form select
  {
    margin: 0px !important;
  }
  .detail_div
  {
    margin-top: 10px;
  }
  .full_info
  {
    margin: 10px;
  }
  .analysis_div
  {
    margin-bottom: 10px !important;
  }
  .analysis_cover
  {
    border: 1px solid;
  }
  .land_size
  {
    display: none;
  }
  .pac-container
  {
    width:300px !important;
  }
  input[type="file"] {
    height: 35px;
    width: 100%;
}
  .inner-nav li a {
    padding: 18px;
  }
  /*input[type="date"]
  {
    padding: 0px;
  }
  .highlights-table td:nth-child(1)
  {
    width:30%;
    word-wrap:break-word;
  }
  .highlights-table td:nth-child(3)
  {
    width:12%;
  }*/
</style>



 
<script src="https://rawgit.com/MattKetmo/darkroomjs/master/build/darkroom.js"></script>

  
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

   <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>



<script type="text/javascript">

  $(function(){
  $("#all_new_collaterals").sortable({
      stop: function (event, ui) {
          countRows(); // re-number rows after sorting
      }
  });
  });
  function countRows() {
      var i = 0;
      var ids=[];
      $('#all_new_collaterals .main_collateral').each(function () {
          //$(this).attr("value", ++i);
          my_id = $(this).attr('id');
        ids.push(my_id); 
      });
      // alert(ids);
      var data =  "&moredata=" + ids +"&loan_id=<%= @loan.id%>";
      $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/collateral_changeorder'
              });

  }

</script>

  <script type="text/javascript">
  $('document').ready(function(){
      
      initialize();
      
      $('#analysis_box').hide();
      $('#profitability_box').hide();

      

      

      $('input[name="mdate"]').mask("99/99/9999",{placeholder:"mm/dd/yyyy"});
      $('input[name="personal_dob"]').mask("99/99/9999",{placeholder:"mm/dd/yyyy"});
      $('input[name="guarantor_birthday"]').mask("99/99/9999",{placeholder:"mm/dd/yyyy"});
      $('input[name="personal_phone"]').mask("(999)999-9999");
      $('input[name="business_phone"]').mask("(999)999-9999");
      $('input[name="guarantor_phone"]').mask("(999)999-9999");
      $('input[name="Phone"]').mask("(999)999-9999");
      
      // $('input[name="maturity_date"]').mask("99/99/9999",{placeholder:"mm/dd/yyyy"});

      $('#send_email').click(function(){

          var data = "&loan_id=<%= @loan.id %>";
          $.ajax({
                    data: data,
                    type: 'POST',
                    url: '/loans/send_email',
                    success:function(response){
                     alert(response);
                   }
                });

      });


      $('.edit_me').click(function(){
          var  str = $(this).attr('id');
          var imgId = str.replace('edit_picture_','');
          $.ajax({
            data: "imgId="+imgId,
            type: 'POST',
            url: '/loans/edit_picture',
            success:function(response){
              $('#edit_pictures_popup').html(response);
              $('#myModal4').foundation('reveal', 'open');
               var dkrm = new Darkroom('#target_pic', {
                // Size options
                minWidth: 100,
                minHeight: 100,
                maxWidth: 600,
                maxHeight: 500,
                ratio: 4/3,
                backgroundColor: '#000',

                // Plugins options
                plugins: {
                  //save: false,
                  crop: {
                    quickCropKey: 67, //key "c"
                    //minHeight: 50,
                    //minWidth: 50,
                    //ratio: 4/3
                  }
                },

                // Post initialize script
                initialize: function() {
                  var cropPlugin = this.plugins['crop'];
                  // cropPlugin.selectZone(170, 25, 300, 300);
                  cropPlugin.requireFocus();
                }
              });


                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
                  ga('create', 'UA-23657373-2', 'mattketmo.github.io');
                  ga('send', 'pageview');
            }
           }); 
      });

  });

  // function sub_val(field)
  // {
  //   new_field = field.replace("_sub","");
  //   field_val = $('#'+field).val();
  //   $('#'+new_field).val(field_val);
  // }

  function show_analysis()
  {
    $('#analysis_box').show();
    $('#profitability_box').show();
    setTimeout(function() {
      $('.tii-controls a').attr('tabindex', '-1');
      $('.tii-controls img').attr('tabindex', '-1');
      $('.cwb-controls img').attr('tabindex', '-1');
      $('.cwb-controls a').attr('tabindex', '-1');
      $('a').attr('tabindex', '-1');
      $('img').attr('tabindex', '-1');
      $('strong').attr('tabindex', '-1');
      $('.trans-info-item').attr('tabindex', '-1');
      $('.trans-info-last').attr('tabindex', '-1');
    }, 3000);
  }

  function hide_analysis()
  {
    $('#analysis_box').hide();
    $('#profitability_box').hide();
    setTimeout(function() {
    $('.tii-controls a').attr('tabindex', '-1');
    $('.tii-controls img').attr('tabindex', '-1');
    $('.cwb-controls img').attr('tabindex', '-1');
    $('.cwb-controls a').attr('tabindex', '-1');
    $('a').attr('tabindex', '-1');
    $('img').attr('tabindex', '-1');
    $('strong').attr('tabindex', '-1');
    $('.trans-info-item').attr('tabindex', '-1');
    $('.trans-info-last').attr('tabindex', '-1');
  }, 3000);
}
</script>
<script>
function callFun(customUrl, divId, formId, plan){
  // alert(divId);
  if(typeof(formId)==='undefined') data = '';
  else data = $('#'+formId).serialize();
  if(typeof(divId)===undefined) divId ='';
   $('#loan_lenders').html('loading...');
  $.ajax({
    type: 'POST',
    url: customUrl,
    data:data,
    success:function(data){

      $('#'+divId).html(data);
      
      if(plan == "SOLO")
      {
        $('#loan-url-form').hide();
      }
      if(plan=="generate_doc_url")
      {
        $('.doc_page').show();
      }
      if(formId=="lender_loans")
      {
        var a_id=divId.replace('loan_lenders','');
        $('#click_'+a_id).hide();
        $('#click_hide_'+a_id).show();
        $("#loan_lenders"+a_id).show();
      }

        },
    error:function(data){
      alert('Something went wrong.');
      
      },
    dataType: 'html',


  });
    
}

function callAjax(customUrl, divId, formId, buttontype){
  // alert(divId);
  if(typeof(formId)==='undefined') data = '';
  else data = $('#'+formId).serialize();
  if(typeof(divId)===undefined) divId ='';
  $.ajax({
    type: 'POST',
    url: customUrl,
    data:data,
    success:function(data){
      // $("#mdate").mask("99/99/9999",{placeholder:"mm/dd/yyyy"});
      
      // *************** Borrower *****************//
     
      $('#'+divId).html(data);
      
     },
    error:function(data){
      alert('Something went wrong.');
      
      },
    dataType: 'html',


  });


    
}

function handleMainImage(files) {
  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    var imageType = /image.*/;
    
    if (!file.type.match(imageType)) {
      continue;
    }
    // $("#main_image_preview").show();
    var img = document.createElement("img");
    img.classList.add("obj");
    img.file = file;
    mainDiv = document.getElementById("main_image_preview");
    mainDiv.innerHTML = '';
    
    mainDiv.appendChild(img); // Assuming that "preview" is a the div output where the content will be displayed.
    
    var reader = new FileReader();
    reader.onload = (function(aImg) { return function(e) { aImg.src = e.target.result; }; })(img);
    reader.readAsDataURL(file);
  }
}

function hide_file(id)
{
  var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_file',
              success:function(response){
                $('#showfor_'+id).show();
                $('#hidefor_'+id).hide();
             }
          });
  
}

function hide_doc(id)
{
  
    var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_doc',
              success:function(response){
                $('#showfile_'+id).show();
                $('#hidefile_'+id).hide();
             }
          });
  
}


function hide_borrower(id)
{
  
    var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_borrower',
              success:function(response){
                $('#showborrower_'+id).show();
                $('#hideborrower_'+id).hide();
             }
          });
 
}

function show_borrower(id)
{
  
    var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/show_borrower',
              success:function(response){
                $('#showborrower_'+id).hide();
                $('#hideborrower_'+id).show();
             }
          });
  
}

function hide_borrower_field(id, field)
{

    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_borrower_field',
              success:function(response){
                $('#show_'+field+'_'+id).show();
                $('#hide_'+field+'_'+id).hide();
             }
          });
  
}

function show_borrower_field(id, field)
{
    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/show_borrower_field',
              success:function(response){
                $('#show_'+field+'_'+id).hide();
                $('#hide_'+field+'_'+id).show();
             }
          });
}

function hide_collateral_field(id, field)
{
  
    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_collateral_field',
              success:function(response){
                $('#showc_'+field+'_'+id).show();
                $('#hidec_'+field+'_'+id).hide();
             }
          });
  
}

function show_collateral_field(id, field)
{
    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/show_collateral_field',
              success:function(response){
                $('#showc_'+field+'_'+id).hide();
                $('#hidec_'+field+'_'+id).show();
             }
          });
}


function hide_loan_field(id, field)
{
  
    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_loan_field',
              success:function(response){
                $('#show_loan_'+field).show();
                $('#hide_loan_'+field).hide();
             }
          });
  
}

function show_loan_field(id, field)
{
    var data = "&id=" + id+"&field="+field;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/show_loan_field',
              success:function(response){
                $('#show_loan_'+field).hide();
                $('#hide_loan_'+field).show();
             }
          });
}

function hide_collateral(id)
{
  
    var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/hide_collateral',
              success:function(response){
                $('#showcollat_'+id).show();
                $('#hidecollat_'+id).hide();
             }
          });
  
}

function show_collateral(id)
{
  
    var data = "&id=" + id;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/show_collateral',
              success:function(response){
                $('#showcollat_'+id).hide();
                $('#hidecollat_'+id).show();
             }
          });
  
}

function edit_picture(id)
{
  var imgId = id;
  $.ajax({
    data: "imgId="+imgId+"&loan_id=<%= @loan.id%>",
    type: 'POST',
    url: '/loans/edit_picture',
    success:function(response){
      $('#edit_pictures_popup').html(response);
      $('#myModal4').foundation('reveal', 'open');
       var dkrm = new Darkroom('#target_pic', {
        // Size options
        minWidth: 100,
        minHeight: 100,
        maxWidth: 600,
        maxHeight: 500,
        ratio: 4/3,
        backgroundColor: '#000',

        // Plugins options
        plugins: {
          //save: false,
          crop: {
            quickCropKey: 67, //key "c"
            //minHeight: 50,
            //minWidth: 50,
            //ratio: 4/3
          }
        },

        // Post initialize script
        initialize: function() {
          var cropPlugin = this.plugins['crop'];
          // cropPlugin.selectZone(170, 25, 300, 300);
          cropPlugin.requireFocus();
        }
      });


        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-23657373-2', 'mattketmo.github.io');
          ga('send', 'pageview');
    }
   }); 
}

function show_file(id)
{
  var data = "&id=" + id;
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/show_file',
            success:function(response){
              $('#hidefor_'+id).show();
              $('#showfor_'+id).hide();
          }
        });
}

function show_doc(id)
{
  var data = "&id=" + id;
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/show_doc',
            success:function(response){
              $('#hidefile_'+id).show();
              $('#showfile_'+id).hide();
          }
        });
}

function del_file(id)
{
  var data = "&id=" + id;
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/del_file',
            success:function(response){
              $('#del_'+id).hide();
          }
        });
}

function del_doc(id)
{
  var data = "&id=" + id;
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/del_doc',
            success:function(response){
              $('#del_file'+id).hide();
          }
        });
}

function del_folder(id)
{
  var data = "&id=" + id;
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/del_folder',
            success:function(response){
              $('#foldr_'+id).hide();
          }
        });
}

function fund_fields()
{
  use = $('.uses_related').val();
  if(use=="Payoff")
  {
    $('.payOff_fund').show();
    $('.purchase_fund').hide();
  }
  else if(use=="Purchase")
  {
    $('.purchase_fund').show();
    $('.payOff_fund').hide();
  }
  else
  {
    $('.payOff_fund').hide();
    $('.purchase_fund').hide();
  }
}

/*********************** Location Functions *************************/
function edit_personal_address(id)
{

  divId = "borrow_"+id;
  $("#"+divId+" #personal_loc_"+id).show();
  $("#"+divId+" .display_personal_loc").hide();
}

function save_personal(id)
{
  divId = "borrow_"+id;
  address = $('input[name="personal_address_'+id+'"]').val();
  city = $('input[name="personal_city_'+id+'"]').val();
  state = $('input[name="personal_state_'+id+'"]').val();
  postalcode = $('input[name="personal_postalcode_'+id+'"]').val();
  
  data = "&personal_address="+address+"&personal_city="+city+"&personal_state="+state+"&personal_postalcode="+postalcode+"&borrower_id="+id;

  $.ajax({
      data: data,
      type: 'POST',
            url: '/loans/save_personal_address',
             success:function(response){
              $("#"+divId+" .display_personal_loc").html(response);
              $("#"+divId+" .display_personal_loc").show();
              $("#"+divId+" #personal_loc_"+id).hide();
          }
        }) ;

}

function cancel_personal(id)
{
  divId = "borrow_"+id;
  $("#"+divId+" #personal_loc_"+id).hide();
  $("#"+divId+" .display_personal_loc").show();
}

function edit_business_address(id)
{

  divId = "borrow_"+id;
  $("#"+divId+" #business_loc_"+id).show();
  $("#"+divId+" .display_business_loc").hide();
}

function save_business(id)
{
  divId = "borrow_"+id;
  address = $('input[name="business_address_'+id+'"]').val();
  city = $('input[name="business_city_'+id+'"]').val();
  state = $('input[name="business_state_'+id+'"]').val();
  postalcode = $('input[name="business_postalcode_'+id+'"]').val();
  
  data = "&business_address="+address+"&business_city="+city+"&business_state="+state+"&business_postalcode="+postalcode+"&borrower_id="+id;

  $.ajax({
      data: data,
      type: 'POST',
            url: '/loans/save_business_address',
             success:function(response){
              $("#"+divId+" .display_business_loc").html(response);
              $("#"+divId+" .display_business_loc").show();
              $("#"+divId+" #business_loc_"+id).hide();
          }
        }) ;

}

function cancel_business(id)
{

  divId = "borrow_"+id;
  $("#"+divId+" #business_loc_"+id).hide();
  $("#"+divId+" .display_business_loc").show();
}

function edit_guarantor_address(id)
{

  divId = "borrow_"+id;
  $("#"+divId+" #guarantor_loc_"+id).show();
  $("#"+divId+" .display_guarantor_loc").hide();
}

function save_guarantor(id)
{
  divId = "borrow_"+id;
  address = $('input[name="guarantor_address_'+id+'"]').val();
  city = $('input[name="guarantor_city_'+id+'"]').val();
  state = $('input[name="guarantor_state_'+id+'"]').val();
  postalcode = $('input[name="guarantor_postalcode_'+id+'"]').val();
  
  data = "&guarantor_address="+address+"&guarantor_city="+city+"&guarantor_state="+state+"&guarantor_postalcode="+postalcode+"&borrower_id="+id;

  $.ajax({
      data: data,
      type: 'POST',
            url: '/loans/save_guarantor_address',
             success:function(response){
              $("#"+divId+" .display_guarantor_loc").html(response);
              $("#"+divId+" .display_guarantor_loc").show();
              $("#"+divId+" #guarantor_loc_"+id).hide();
          }
        }) ;

}

function cancel_guarantor(id)
{

  divId = "borrow_"+id;
  $("#"+divId+" #guarantor_loc_"+id).hide();
  $("#"+divId+" .display_guarantor_loc").show();
}

function edit_address(id)
{

  divId = "collateral_"+id;
  $("#"+divId+" #collateral_loc_"+id).show();
  $("#"+divId+" .display_collateral_loc").hide();
}

function save_address(id)
{
  divId = "collateral_"+id;
  address = $('input[name="address_'+id+'"]').val();
  city = $('input[name="city_'+id+'"]').val();
  state = $('input[name="state_'+id+'"]').val();
  postalcode = $('input[name="postalcode_'+id+'"]').val();
  
  data = "&address="+address+"&city="+city+"&state="+state+"&postalcode="+postalcode+"&collateral_id="+id;

  $.ajax({
      data: data,
      type: 'POST',
            url: '/loans/save_collateral_address',
             success:function(response){
              $("#"+divId+" .display_collateral_loc").html(response);
              $("#"+divId+" .display_collateral_loc").show();
              $("#"+divId+" #collateral_loc_"+id).hide();

              new_data = "&collateral_id="+id;
              $.ajax({
                data: new_data,
                type: 'POST',
                      url: '/loans/fetch_location_map',
                       success:function(response){
                        $("#"+divId+" .map_inner").html(response);
                        $("#"+divId+" .map_outer").show();
                    }
                  }) ;
          }
        }) ;

}

function cancel_address(id)
{
  divId = "collateral_"+id;
  $("#"+divId+" #collateral_loc_"+id).hide();
  $("#"+divId+" .display_collateral_loc").show();
}

function save_value(field_name, type)
{
    var field_value = $('input[name="'+field_name+'"]').val();
    var data = "&loan_id=<%= @loan.id %>"+"&"+field_name+"="+field_value+"&ftype="+type;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/save_loan_data',
              success:function(response){
                $('input[name="'+field_name+'"]').val(response);
                 $('input[name*="'+field_name+'_sub"]').val(response);
             }
          });
}

function save_sub_value(field_name, type, num)
{
    if(num!=1)
    {
      var field_value = $('input[name="'+field_name+'_sub'+num+'"]').val();
    }
    else
    {
      var field_value = $('input[name="'+field_name+'_sub'+'"]').val();
    }
    // alert(field_value);
    
    var data = "&loan_id=<%= @loan.id %>"+"&"+field_name+"="+field_value+"&ftype="+type;
    $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/save_loan_data',
              success:function(response){
                // alert(response)
                // $('input[name="'+field_name+'"]').val(response);
                // if(num!="")
                // {
                //   $('input[name="'+field_name+'_sub'+num+'"]').val(response);
                // }
                // else
                // {
                //   $('input[name="'+field_name+'_sub"]').val(response); 
                // }
                $( "input[name*='"+field_name+"']" ).val(response);
                $( "input[name*='"+field_name+"_sub']" ).val(response);
                
                // alert(field_name+" "+response);
             }
          });
  
}


/*********************** End Location Functions *************************/

$('document').ready(function(){
  $( ".lender_status" ).change(function() {
    var status=$(this).val();
    var id=$(this).attr('id');
    var lender_id=id.replace('lender','');
    var data = "&status=" +status
    $.ajax({
      data: data,
      type: 'POST',
            url: '/loan_urls/'+lender_id+'/save_status',
             success:function(response){
              $('#del_'+id).hide();
          }
        }) ;
  });

  $('#add_new_borrower').click(function(){
    loan_id = "<%=@loan.id%>"
    $.ajax({
            data: "loan_id="+loan_id,
            type: 'POST',
            url: '/loans/add_new_edit_borrower',
            success:function(response){
              $('#all_new_borrowers').html(response);
              initialize();
            }
        }); 
  });

  $('#add_new_collateral').click(function(){
    loan_id = "<%=@loan.id%>"
    $.ajax({
            data: "loan_id="+loan_id,
            type: 'POST',
            url: '/loans/add_new_edit_collateral',
            success:function(response){
              $('#all_new_collaterals').html(response);
               initialize();
              $('.payoff_edit').click(function(){
                  colId = $(this).parents('.main_collateral').attr('id');
                  $('#'+colId+' .payoff_add_edit').show();
                  $('#'+colId+' .payoff_info').hide();
                });
              $('.cancel_payoff').click(function(){
                colId = $(this).parents('.main_collateral').attr('id');
                $('#'+colId+' .payoff_add_edit').hide();
                $('#'+colId+' .payoff_info').show();
              });
               $('.save_payoff').click(function(){
                  colId = $(this).parents('.main_collateral').attr('id');
                  var data=$('#'+colId+' .payOffForm').serialize();
                  $.ajax({
                          data: data,
                          type: 'POST',
                          url: '/loans/add_payoff',
                          success:function(response){
                            $('#'+colId+' .payoff_info').html(response);
                           
                            $('#'+colId+' .payoff_add_edit').hide();
                            $('#'+colId+' .payoff_info').show();     
                          }
                      });
                });
                $('.add_more_payoff').click(function(){
                  $(".collateral_append_here").append("<div class='large-12 columns'><div class='small-8 columns'><input type='text' name='amount[]' placeholder='Amount'></div><div class='small-4 columns'><input type='text' name='recipient[]' placeholder='Recipient'><input type='hidden' name='id[]' value=''></div>");
                  });

            }
        });

  });

  $("#add_custom_folder").click(function(){
    $(".add_new_folder").slideToggle();   
  });

  $("#cancel_add_folder").click(function(){
    $(".add_new_folder").hide();
    $(".folder_name").val("")
  });

  $("#add_folder").click(function(){
    var data=$('#add_folder_form').serialize();
    $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/add_folder',
            success:function(response){
              $(".add_new_folder").hide();
              $(".folder_name").val("")
              $(".custom_folders").html(response);
            }
        });
  });

  $('#accept').click(function(){
        
      $('#myModal').foundation('reveal', 'close'); 
      $('#confirmation').foundation('reveal', 'open');
    });

     $('#confirm_shop').click(function(){
        var allVals = [];
        sorting_type = $('#sorting').val();
        group_type = $('#shopping_outcome').val();
        var data = "&id=<%= @loan['_id'] %>"+"&group_type="+group_type;
        $.ajax({
                data: data,
                type: 'POST',
                url: '/loans/single_shop_loan',
                success:function(response){
                   $('#confirmation').foundation('reveal', 'close');   
                    window.location.href = "https://dash.idvstage.us/loans/shop_loans/listing"; 
                   //alert("Your shop loan request has been sent to admin.");
                }
            });
    });

    $('#cancel_shop').click(function(){
        $('#confirmation').foundation('reveal', 'close');
    });

    
    $('#cancel_accept').click(function(){
      $('#myModal').foundation('reveal', 'close');
    });

   

    $('.add_more_payoff').click(function(){
    $(".append_here").append("<div class='large-12 columns'><div class='small-8 columns'><input type='text' name='amount[]' placeholder='Amount'></div><div class='small-4 columns'><input type='text' name='recipient[]' placeholder='Recipient'><input type='hidden' name='id[]' value=''></div>");
  });

  // $('.add_more').click(function(){
    
 //     var data="&loan_id=<%= @loan['_id'] %>";
  //  $.ajax({
 //            data: data,
 //            type: 'POST',
 //            url: '/loans/all_funds',
 //            success:function(response){
 //             $( ".append_here" ).html(response);
 //           $( ".append_here" ).append( "<div class='large-12 columns'><div class='small-8 columns'> <input type='text' name='use[]' placeholder='Description'></div><div class='small-4 columns'><input type='text' name='amount[]' placeholder='Amount'></div></div>" );      
 //             }

  //    }); 
  // });

  // $('#save_funds').click(function(){
  //  var data=$('#fundsForm').serialize();
  //  $.ajax({
 //            data: data,
 //            type: 'POST',
 //            url: '/loans/add_loan_funds',
 //            success:function(response){
 //             $('#fund_info').html(response);
 //           $('#fund_add_edit').hide();
  //      $('#fund_info').show();     
 //             }
 //        });
  // });





  $('.save_payoff').click(function(){
    var data=$('.payOffForm').serialize();
    $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/add_payoff',
            success:function(response){
              $('.payoff_info').html(response);
              $('.payoff_add_edit').hide();
              $('.payoff_info').show();     
            }
        });
  });

  $('.fund_edit').click(function(){
    

    var data = "&loan_id=<%= @loan.id %>"
            $.ajax({
                data: data,
                type: 'POST',
                url: '/loans/edit_all_funds',
                 success:function(response){
                  $('#fund_add_edit').html(response);
                  $('#fund_add_edit').show();
                  $('#fund_info').hide();
                }
            }) ;
  });

  $('#cancel_funds').click(function(){
    $('#fund_add_edit').hide();
    $('#fund_info').show();
  });

  $('.payoff_edit').click(function(){
    $('.payoff_add_edit').show();
    $('.payoff_info').hide();
  });

 
  $('.cancel_payoff').click(function(){
    $('.payoff_add_edit').hide();
    $('.payoff_info').show();
  });

  $('.share_page').click(function(){
    $('#myModal3').foundation('reveal', 'open');
  });

  $('.show_doc_div').click(function(){
    $('.doc_page').slideToggle();
  });
  

  
});

function copyToClipboard(text) {
  window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
}



function loan_location()
{
  $('#l_location').show();
  $('.loc').hide();
}

function loans_location()
{
  $('#loc_location').show();
  $('.loctn').hide();
  $('.loctn_name').hide();
  $('.loc_edit_pen').hide();
}


function location_edit()
{
  var data=$('#loc_form').serialize();
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/save_edit_loc',
            success:function(response){
              var address=$('#loc_address').val();
              var city=$('#loc_city').val();
              var state=$('#loc_state').val();
              $('#loan_location').html(city+', '+state);
              $('#highlight_address').html(address);
              $('#highlight_city').html(city);
              $('#highlight_state').html(state);
              $('.loctn').html(city+', '+state);
              $('.loc').show();
              $('#l_location').hide();
              $('#place_featured_image').html(response);

            }
        });
}

function locations_edit()
{

  var data=$('#loctn_form').serialize();
  $.ajax({
            data: data,
            type: 'POST',
            url: '/loans/save_edit_loc',
            success:function(response){
              var city=$('#loctn_city').val();
              var state=$('#loctn_state').val();
              var loan_name=$('#loctn_name').val();
              // alert(loan_name);
              $('#loan_location').html(city+', '+state);
              $('.loctn_loc').html(city+', '+state);
              $('#highlight_address').html(city+', '+state)
              $('.loctn_name').html(loan_name);
              $('.loc').show();
              $('.loctn').show();
              $('#loc_location').hide();
              $('#l_location').hide();
              $('.loc_edit_pen').show();
              $('.loctn_name').show();
            }
        });
}

function cancel_loc()
{
  $('#l_location').hide();
  $('.loc').show();
}

function cancel_locatn()
{
  $('#loc_location').hide();
  $('.loctn').show();
  $('.loctn_name').show();
  $('.loc_edit_pen').show();
}


function lender_change(sts, id)
    {
            var status=sts.value;
            var lender_id=id;
            var data = "&status=" +status
            $.ajax({
                data: data,
                type: 'POST',
                url: '/loan_urls/'+lender_id+'/save_status',
                 success:function(response){
                    $('#del_'+id).hide();
                }
            }) ;
    }

function shop_loan()
{
    
        $('#myModal').foundation('reveal', 'open');    
}

function add_notes(id)
{
  
      var data = "&for_id=" +id+ "&loan_id=<%= @loan.id %>"
    $.ajax({
      data: data,
      type: 'POST',
      url: '/loans/add_notes',
      success:function(response){
        $('#note_content').html(response);
        $('#myModal2').foundation('reveal', 'open');
      }
    }) ;
}

function add_related_funds(id)
{
    var data = "&collateral_id=" +id+ "&loan_id=<%= @loan.id %>"
    $.ajax({
      data: data,
      type: 'POST',
      url: '/loans/add_related_fund',
      success:function(response)
      {
        $('.col_related_funds').html(response);
        $('#myModal5').foundation('reveal', 'open');
      }
    });
  
}

function after_add_funds(resp, id)
{
    $('#collateral_'+id+' .related_collats').html(resp);
    var data = "&loan_id=<%= @loan.id %>"
    $.ajax({
      data: data,
      type: 'POST',
      url: '/loans/after_related_funds',
      success:function(response)
      {
        $('.table-use-fund').html(response);
        $('#myModal5').foundation('reveal', 'close');
      }
    });
}

function remove_related_fund(col_id, fund_id)
{
  var data = "&collateral_id="+col_id+"&fund_id="+fund_id;
  $.ajax({
      data: data,
      type: 'POST',
      url: '/loans/remove_related_funds',
      success:function(response)
      {
        $('#collateral_'+col_id+' .related_collats').html(response);
      }
    }); 
}
</script>

<!-------------------------- Location Google API ------------------------------>
  
  <script type="text/javascript">
  var autocomplete = {};
    var autocompletesWraps = <%= raw @brwrId.to_json %>;

   autocompletesWraps.forEach(function(this_form) {
       // alert(this_form)
       window[this_form+'_form']  = { street_number: 'short_name', route: 'long_name', locality: 'long_name', administrative_area_level_1: 'long_name', country: 'long_name', postal_code: 'short_name' };
        ++this.count;
      }, this);

    function initialize() {
      $.each(autocompletesWraps, function(index, name) {
      
        if($('#'+name).length == 0) {
          return;
        }

       
        autocomplete[name] = new google.maps.places.Autocomplete($('#'+name+' .autocomplete')[0], { types: ['geocode'] });
          
        google.maps.event.addListener(autocomplete[name], 'place_changed', function() {
          
          var place = autocomplete[name].getPlace();
          var form = eval(name+'_form');
          // var form = eval(name);

          for (var component in form) {
            $('#'+name+' .'+component).val('');
            $('#'+name+' .'+component).attr('disabled', false);
          }
          
          for (var i = 0; i < place.address_components.length; i++) {
            var addressType = place.address_components[i].types[0];
            if (typeof form[addressType] !== 'undefined') {
              var val = place.address_components[i][form[addressType]];
              $('#'+name+' .'+addressType).val(val);
               // alert(name+" "+addressType+" - "+val);
            }


          }

          if (name.indexOf("collateral_loc") >= 0)
          {
            setTimeout(function(){
                  
              id_col = name.replace("collateral_loc_","")
              address = $('#'+name+' #address_'+id_col).val();
              city = $('#'+name+' #city_'+id_col).val();
              state = $('#'+name+' #state_'+id_col).val();
              postalcode = $('#'+name+' #postalcode_'+id_col).val();

              data = "&address="+address+"&city="+city+"&state="+state+"&postalcode="+postalcode+"&collateral_id="+id_col;

              $.ajax({
                  data: data,
                  type: 'POST',
                        url: '/loans/save_collateral_address',
                         success:function(response){
                         

                          new_data = "&collateral_id="+id_col;
                          $.ajax({
                            data: new_data,
                            type: 'POST',
                                  url: '/loans/fetch_location_map',
                                   success:function(response){
                                    $("#collateral_"+id_col+" .map_container").html(response);
                                }
                              }) ;
                      }
              });
            }, 3000);
          }
          
                        
                  // data = "&guarantor_address="+address+"&guarantor_city="+city+"&guarantor_state="+state+"&guarantor_postalcode="+postalcode+"&borrower_id="+id;

                  // $.ajax({
                  //     data: data,
                  //     type: 'POST',
                  //           url: '/loans/save_guarantor_address',
                  //            success:function(response){}
                  //       }) ;

                
          
        });


      });
    }
</script>
  

<!-------------------------- End Location Google API ------------------------------>
<script>
    $(function () {

        var loading = $("#loading_img");
        $(document).ajaxStart(function () {
          $("#loading_img").show();
        });

        $(document).ajaxStop(function () {
            $("#loading_img").hide();
        });
      
      });
</script>
<style type="text/css">
  #loading_img{
  position:fixed;
  top:0px;
  right:0px;
  width:100%;
  height:100%;
  background-color:#666;
  background-image:url('/assets/ajaxloader.gif');
  background-repeat:no-repeat;
  background-position:center;
  z-index:10000000;
  opacity: 0.4;
  filter: alpha(opacity=40); /* For IE8 and earlier */
}
</style>
<div id="loading_img" style="display:none"></div>



<div id="confirmation" class="reveal-modal small" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
  <div class="modalhead">
    <h5 id="modalTitle" style="font-weight:bold;"> Select Shopping Outcome </h5>
  </div>
  <p>
      <select id="shopping_outcome">
        <option value="standard_shop">Standard Shop</option>
        <% unless @groups.blank? %>
            <% @groups.each do |group| %>
                <option value="<%= group.id %>"><%= group.name %></option>
            <% end %>
        <% end %>
      </select>
  </p>
  <input type="button" class="tiny button" value="Confirm" id="confirm_shop">
  <input type="button" class="alert tiny button" value="Cancel" id="cancel_shop">
  <a class="close-reveal-modal" aria-label="Close">&#215;</a>
</div>


<div id="myModal2" class="reveal-modal medium" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
  <div class="modalhead" id="note_content">
  </div>
  <a class="close-reveal-modal" aria-label="Close">&#215;</a>
</div>

<!----------------------- Share Page Lender -------------------------->
<div id="myModal3" class="reveal-modal large" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
  <div class="row" id="show-urlxs">
        <%= render partial: 'loan_url_forms' %>
  </div>
  <a class="close-reveal-modal" aria-label="Close">&#215;</a>
</div>
<!----------------------- End Share Page Lender -------------------------->

<!----------------------- Collateral Funds Popup -------------------------->

  <div id="myModal5" class="reveal-modal medium" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <div class="modalhead">
      <h5 id="modalTitle" style="font-weight:bold; allign-text">Add Fund</h5>
    </div>
    <div class="col_related_funds">

    </div>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
  </div>

  <div id="myModal6" class="reveal-modal small" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <div class="modalhead">
      <div class="row">
        <label for="Email">Enter Email</label>
        <input id="form_email" type="text"  autofocus="autofocus" name="form_email">
      </div>
      <div class="row">
        <input class="tiny button" type="submit" value="SEND LINK" id="send_form_link">
      </div>
    </div>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
  </div>

<!----------------------- Collateral Funds Popup -------------------------->

<% 
# if defined? @num
#   @form_show = ""
#   @user_plan = ""
#   if(@brokerLogin==true ) 
#     if defined?@infoBroker.plan 
#       if @infoBroker.plan == "SOLO"
#         @user_plan = "SOLO"
#         if (@num == 1 || @num>1)  
#           @form_show = "no" 
#         end
#       end
#     end
#    end 
# end%>
<!---------------------- Header ---------------------------------->
<div class="alert-bar">
    <div class="row">
        <div class="text-center">
            <div class="alear-message">
              <strong>Alert:</strong>
              <% if @numOfLenders!= 0 %>
               <span id="lenders_info">You have <%= @numOfLenders %> compatible lender(s)</span>
              <% else %>
               <span id="lenders_info">Shop your loan now.</span>
              <% end %>
            </div>
            <!-- <a href="javascript:void(0);" onclick="shop_loan()">Shop Now</a> -->
            <!-- <a href="#" class="btn-shop-later">Shop Later</a> -->
        </div>
    </div>
</div>
<section class="title-bar">
    
    <div class="row loctn">
        <img src="/assets/edit-icon.png" class="edit-icon loc_edit_pen" style="position: absolute; margin-left: -30px; margin-top: 10px;" onclick="loans_location()">
        <h1 id='_LoanName' class="llname loctn_name"><%= @loan.info['_LoanName'] %></h1>
        <h3 class="sub-heading loctn_loc">
          <%=@loan.info['City3']%>
          <% if !@loan.info['City3'].blank? && !@loan.info['State3'].blank?%>
            ,
          <% end %> 
          <%=@loan.info['State3']%>
        </h3>
        
    </div>

    <div id="loc_location"  style="display:none;">
          <form name="loctn_form" id="loctn_form" >
            <div>
                <b>Loan Name</b>
                <br>
                <div style="max-width:800px;margin-left:auto;margin-right:auto;">
                  <input id="loctn_name" type="text" value="<%=@loan.info['_LoanName']%>" rows="1" name="_LoanName" >
                </div>
            </div>
                <div>
                  <b>Address</b>
                  <br>
                  <div style="max-width:800px;margin-left:auto;margin-right:auto;">
                    <input id="loctn_address" type="text" value="<%=@loan.info['Address3']%>" rows="1" name="Address3" class="autocomplete">
                  </div>
            </div>
            <div>
              <b>City</b>
              <br>
              <div style="max-width:800px;margin-left:auto;margin-right:auto;">
                <input id="loctn_city" type="text" value="<%=@loan.info['City3']%>" rows="1" name="City3" class="locality">
              </div>
            </div>
            <div>
              <b>State</b>
              <br>
              <div style="max-width:800px;margin-left:auto;margin-right:auto;">
                <input id="loctn_state" type="text" value="<%=@loan.info['State3']%>" rows="1" name="State3" class = "field administrative_area_level_1">
                <input type="hidden" name="id" value="<%=@loan['_id']%>">
              </div>
            </div>
            <button class="tiny button" type="button" onclick="locations_edit()">Save</button>
            <button class="tiny button" type="button" onclick="cancel_locatn()" name="button" data-disable-with="Please wait...">Cancel</button>

          </form>
    </div>
</section><!-- banner-section -->


<!---------------------- Header End ------------------------------>


<% if(@brokerLogin==true && @adminLogin!=true) %>
  <div id='show-urls' style='padding-left:50px;padding-right:50px;'>
  <%= render partial: 'loan_url_form'%>
  </div>
<% end %>
<% if policy(@loan).update? %>
<div id='show-urls' style='padding-left:50px;padding-right:50px;'>
  <%= render partial: 'loan_url_form'%>
</div>

<% end %>

<section class="content-section">
  <div class="container">
    <div class="row">
      <div class="columns small-12">
        <ul class="inner-nav tabs" data-tab>
            <li class="active"><a href="#overview" onclick="return hide_analysis();">Overview</a></li>
            <li><a href="#borrowers" onclick="return hide_analysis();">Borrowers</a></li>
            <li><a href="#collaterals" onclick="return hide_analysis();">Collateral</a></li>
            <li><a href="#exit_strategy" onclick="return hide_analysis();">Exit Strategy</a></li>
            <li><a href="#pictures" onclick="return hide_analysis();">Pictures</a></li>
            <li><a href="#documents" onclick="return hide_analysis();">Documents</a></li>
            <li><a href="#contact" onclick="return hide_analysis();">Contact</a></li>
        </ul>
      </div>
      <div class="columns medium-8">
        <div class="tabs-content" style="margin-top:35px;">
          <div class="content active" id="overview">
            <div id="place_featured_image">
              <%= render partial: 'edit_featured_image' %>
            </div>
            <%= render partial: 'edit_overview' %>
          </div><!---- overview -------->
          <div class="content" id="borrowers">
            <%= render partial: 'edit_borrower' %>
          </div>
          <div class="content" id="collaterals">
            <%= render partial: 'edit_collateral'%>
          </div>
          <div class="content" id="exit_strategy">
            <%=render partial: 'edit_exitstrategy'%>
          </div>
          <div class="content" id="pictures">
            <div class="content-white-box">
              <div class="all_loan_contents" id='pictures-container' >
                <%=render partial: 'editt_thumbnails', locals:{images: @images, loan_id:@loan._id}%>
              </div>
            </div>
          </div>
          <div class="content" id="documents">
            <div class="content-white-box">
              <div class="all_loan_contents">
                <%=render partial: 'editt_documents'%>
              </div>
            </div>
          </div>
          <div class="content" id="contact">
            <%= render partial: 'edit_contact_information' %>    
          </div>
        </div><!--- Tabs Content ------>
      </div>
      <div class="columns medium-4 sidebar">
        <a href="https://<%= @hostname %>/loans/detail/<%= @loan.id %>" class="button" target="_blank" style="width:301px;"> See What A Lender Will See </a>
        <div class="sidebar-item" >
          <%=render partial: 'edit_highlights'%>
        </div>
      </div>
    </div>
  </div>
</section>
<!--------------------------- New Design -------------------------->
<script type="text/javascript">
    $('document').ready(function(){
      // tab_link.attr({"aria-selected": "true", tabindex: 0});

      $('input[name="maturity_date"]').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});
      $('input[name="original_purchase_date"]').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});
      $('input[name="contract_closing_date"]').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});
      $('input[name="_ExpectedCloseDate"]').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});
      $('.maturityDates').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});
      $('.contractDates').inputmask('mm/dd/yyyy',{placeholder:"MM/DD/YYYY"});

      $('.loan_summary').change(function(){
        this_val = $(this).val();
        field_name = "_LoanSummaryWhatareyoulookingfor";
        data = "&field="+field_name+"&value="+this_val+"&loan_id=<%= @loan.id %>";
        $.ajax({
              data: data,
              type: 'POST',
              url: '/loans/save_loan_field',
              success:function(response){
              }
          });

      });

      $('.loan_info_fields').change(function(){


        this_val = $(this).val();
        field_name = $(this).attr('name');
        
        
        /*************** Transaction Type *******************/
          if(field_name=="transaction_type")
          {
            if(this_val=="Purchase")
            {
              $('.purchase').show();
              $('.refinance').hide();
            }
            else if(this_val=="Refinance")
            {
              $('.refinance').show();
              $('.purchase').hide(); 
            }
            else
            {
              $('.refinance').hide();
              $('.purchase').hide(); 

            }


          }
        /*************** Transaction Type *******************/

        /*************** Is Broker **************************/
          
          if(field_name=="isBroker")
          {
            if(this_val=="Yes")
            {
              $('.yes_broker').show();
              $('.ask_broker').addClass('border-right');
            }
            else
            {
              $('.yes_broker').hide();
              $('.ask_broker').removeClass('border-right'); 
            }
          }
        /*************** Is Broker End **********************/

        /*************** Free Clear **************************/
          
          if(field_name=="free_clear")
          {
            if(this_val=="Yes")
            {
              $('.free_clear').show();
            }
            else
            {
              $('.free_clear').hide(); 
            }
          }
        /*************** Free Clear End **********************/
        
        /*************** Loan Categorys **********************/
          if(field_name=="_LendingCategory")
          {
            if(this_val == "Private Real Estate Loan")
            {
              $('#_LendingTypes').show();
              $('#_BusinessFinancingTypes').hide();
              $('#_EquityandCrowdFunding').hide();
              $('#_MortageTypes').hide();
            }
            else if(this_val == "Business Financing")
            {
              $('#_LendingTypes').hide();
              $('#_BusinessFinancingTypes').show();
              $('#_EquityandCrowdFunding').hide();
              $('#_MortageTypes').hide();
            }
            else if(this_val == "Equity and Crowdfunding")
            {
              $('#_LendingTypes').hide();
              $('#_BusinessFinancingTypes').hide();
              $('#_EquityandCrowdFunding').show();
              $('#_MortageTypes').hide();
            }
            else if(this_val == "Residential or Commercial Mortgage")
            {
              $('#_LendingTypes').hide();
              $('#_BusinessFinancingTypes').hide();
              $('#_EquityandCrowdFunding').hide();
              $('#_MortageTypes').show();
            }
          } 

        /*************** Loan Categorys End **********************/

        /***************** Highlight Address Save **********************/
          setTimeout(function(){
          if(field_name=="Address3" || field_name=="City3" || field_name=="State3")
          {
            city_val = $('#loc_city').val();
            state_val = $('#loc_state').val();
            address_val = $('#loc_address').val();
            data = "&"+field_name+"="+this_val+"&id=<%= @loan.id %>"+"&City3="+city_val+"&State3="+state_val+"&Address3="+address_val;
            $.ajax({
                data: data,
                type: 'POST',
                url: '/loans/save_edit_loc',
                success:function(response){
                  $('.loctn_loc').html(city_val+', '+state_val);
                  $('#place_featured_image').html(response);
                }
            });
          }
          }, 3000);

        /***************** Highlight Address Save **********************/

        /******************** Land Size **********************/
          if(field_name=="size")
          {
            if(this_val=="Sq Footage")
            {
              $('.sq_footage').show();
              $('.acres').hide();
            }
            else if(this_val=="Acres")
            {
              $('.acres').show();
              $('.sq_footage').hide();
            }
          }

        /******************** End Land Size **********************/
          if(field_name=="_NetLoanAmountRequested0" || field_name == "_EstimatedMarketValue")
          {
            data = "&field="+field_name+"&value="+this_val+"&loan_id=<%= @loan.id %>";
            $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/save_loan_money',
                  success:function(response){
                    $('input[name="'+field_name+'"]').val(response);
                  }
            });
          }
          else
          {
            data = "&field="+field_name+"&value="+this_val+"&loan_id=<%= @loan.id %>";
            $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/save_loan_field',
                  success:function(response){
                  }
            });
          }
          
        /********************** Fetch Lenders **********************/

          if(field_name=="_NetLoanAmountRequested0" || field_name=="_LendingCategory" || field_name=="Address3"  || field_name=="State3")
          {
            data = "&loan_id=<%= @loan.id %>";
            $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/fetch_lenders',
                  success:function(response){
                    $('#lenders_info').html(response)
                  }
              });
          }

        /********************** Fetch Lenders End **********************/

        /********************** Expected Closed Date ******************/
        if(field_name=="_ExpectedCloseDate")
          {
            $('#_ExpectedCloseDate').val(this_val);

          }
        /********************** End Expected Closed Date ******************/
      });

      /************************** Save Collateral Data ********************************/
      

        $('.collateral_info_fields').change(function(){

            this_val = $(this).val();
            field_name = $(this).attr('name');
            this_id = $(this).attr('id');
            id = this_id.replace(field_name+"_", "");
        /**************** Location Function ******************/
          // if(field_name=="address")
          // {
          //   // alert("hey...")

          //   setTimeout(function(){
          //   address = this_val;
          //   city = $('#city_'+id).val();
          //   state = $('#state_'+id).val();
          //   postalcode = $('#postalcode_'+id).val();
            
          //   data = "&address="+address+"&city="+city+"&state="+state+"&postalcode="+postalcode+"&collateral_id="+id;

          //   $.ajax({
          //       data: data,
          //       type: 'POST',
          //             url: '/loans/save_collateral_address',
          //              success:function(response){
                       

          //               new_data = "&collateral_id="+id;
          //               $.ajax({
          //                 data: new_data,
          //                 type: 'POST',
          //                       url: '/loans/fetch_location_map',
          //                        success:function(response){
          //                         $("#collateral_"+id+" .map_container").html(response);
          //                     }
          //                   }) ;
          //           }
          //         }) ;
          //   }, 3000);

          // }
          
        /**************** Location Function ******************/
        /******************** Land Size **********************/
          if(field_name=="size")
          {
            if(this_val=="Sq Footage")
            {
              $('.sq_footage').show();
              $('.acres').hide();
            }
            else if(this_val=="Acres")
            {
              $('.acres').show();
              $('.sq_footage').hide();
            }
          }

        /******************** End Land Size **********************/

        /******************** Structural Size ********************/
          if(field_name=="structural_size")
          {
            if(this_val=="Sq Footage")
            {
              $('.ask_structural_size').removeClass('medium-12 ');
              $('.ask_structural_size').addClass('medium-6  border-right');
              $('.structure_sq_footage').show();
              $('.structure_units').hide();
            }
            else if(this_val=="Units")
            {
              $('.ask_structural_size').addClass('medium-12');
              $('.ask_structural_size').removeClass('medium-6  border-right');
              $('.structure_sq_footage').hide();
              $('.structure_units').show();
            }
            else
            {
              $('.ask_structural_size').addClass('medium-12');
              $('.ask_structural_size').removeClass('medium-6  border-right');
              $('.structure_sq_footage').hide();
              $('.structure_units').hide(); 
            }
          }



        /******************** End Structural Size ********************/
        
          if(field_name=="estimated_value" || field_name=="amount_owed" || field_name=="gross_monthly_income" || field_name == "noi_ytd" || field_name == "noi_two_years_ago" )
          {
            data = "&field="+field_name+"&value="+this_val+"&collateral_id="+id;
            // alert(data);
            $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/save_collateral_money',
                  success:function(response){
                    $("#"+field_name+"_"+id).val(response);
                  }
              });
          } 
          else
          {

            data = "&field="+field_name+"&value="+this_val+"&collateral_id="+id;
            // alert(data);
            $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/save_collateral_field',
                  success:function(response){
                  }
              });
          } 

          

          

          /********************** Collateral Analysis ********************************/
            setTimeout(function(){
            if(field_name=="acres")
            {
              
               
                var data = "&loan_id=<%= @loan.id %>&field=land_square_footage";
                 $.ajax({
                        data: data,
                        type: 'POST',
                        url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }



            if(field_name=="sq_footage")
            {
              
              
                var data = "&loan_id=<%= @loan.id %>&field=land_square_footage";
                 $.ajax({
                        data: data,
                        type: 'POST',
                        url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }

            if(field_name=="gross_monthly_income")
            {
              
               
                var data = "&loan_id=<%= @loan.id %>&field=gross_monthly_income";
                 $.ajax({
                        data: data,
                        type: 'POST',
                        url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
             

            }

            if(field_name=="noi_ytd")
            {
              
                
                var data = "&loan_id=<%= @loan.id %>&field=noi_ytd";
                 $.ajax({
                        data: data,
                        type: 'POST',
                       url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
             

            }

            if(field_name=="structural_size")
            {
              
               
                var data = "&loan_id=<%= @loan.id %>&field=noi_ytd";
                 $.ajax({
                        data: data,
                        type: 'POST',
                       url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }

            if(field_name=="units")
            {
              
                
                var data = "&loan_id=<%= @loan.id %>&field=noi_ytd";
                 $.ajax({
                        data: data,
                        type: 'POST',
                       url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }

            if(field_name=="structural_sq_footage")
            {
              
                
                var data = "&loan_id=<%= @loan.id %>&field=structural_sq_footage";
                 $.ajax({
                        data: data,
                        type: 'POST',
                       url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }

            if(field_name=="sf_per_unit")
            {
              
                
                var datas = "&loan_id=<%= @loan.id %>&field=noi_ytd";
                 $.ajax({
                        data: datas,
                        type: 'POST',
                       url: '/loans/edit_analysis_data',
                        success:function(response){
                          $('#analysis_information').html(response);
                        }
                 });
              

            }
          },3000);
            // alert("df");
        /********************** End Collateral Analysis ***************************/

        });

      /************************** End Save Collateral Data ********************************/

      /************************** Save Borrower Data ***************************************/
         $('.borrower_edit_field').change(function(){
            this_val = $(this).val();
            field_name = $(this).attr('name');
            this_id = $(this).attr('id');
            id = this_id.replace(field_name+"_", "");
            borId = "borrow_"+id;

            /**************** Location Function ******************/
              if(field_name=="personal_address")
              {
                // alert("hey...")

                setTimeout(function(){
                  address = $('#personal_address_'+id).val();
                  city = $('#personal_city_'+id).val();
                  state = $('#personal_state_'+id).val();
                  postalcode = $('#personal_postalcode_'+id).val();
                  
                  data = "&personal_address="+address+"&personal_city="+city+"&personal_state="+state+"&personal_postalcode="+postalcode+"&borrower_id="+id;

                  $.ajax({
                      data: data,
                      type: 'POST',
                            url: '/loans/save_personal_address',
                             success:function(response){
                              
                          }
                        }) ;

                }, 3000);

              }

              if(field_name=="business_address")
              {
                // alert("hey...")

                setTimeout(function(){
                  // divId = "borrow_"+id;
                  address = $('#business_address_'+id).val();
                  city = $('#business_city_'+id).val();
                  state = $('#business_state_'+id).val();
                  postalcode = $('#business_postalcode_'+id).val();
                  
                  data = "&business_address="+address+"&business_city="+city+"&business_state="+state+"&business_postalcode="+postalcode+"&borrower_id="+id;

                  $.ajax({
                      data: data,
                      type: 'POST',
                            url: '/loans/save_business_address',
                             success:function(response){
                             
                          }
                        }) ;

                }, 3000);

              }

              if(field_name=="guarantor_address")
              {
                // alert("hey...")

                setTimeout(function(){
                  // divId = "borrow_"+id;
                  address = $('#guarantor_address_'+id).val();
                  city = $('#guarantor_city_'+id).val();
                  state = $('#guarantor_state_'+id).val();
                  postalcode = $('#guarantor_postalcode_'+id).val();
                  
                  data = "&guarantor_address="+address+"&guarantor_city="+city+"&guarantor_state="+state+"&guarantor_postalcode="+postalcode+"&borrower_id="+id;

                  $.ajax({
                      data: data,
                      type: 'POST',
                            url: '/loans/save_guarantor_address',
                             success:function(response){}
                        }) ;

                }, 3000);

              }

             
          
        /**************** Location Function ******************/
            /******************* Borrower Type *********************/
            if(field_name=="borrower_type")
            {
              if(this_val=="Individual")
              {
                $('#'+borId+' .business_info').hide();
                $('#'+borId+' .business_financials').hide();
                $('#'+borId+' .guarantor_info').show();
                $('#'+borId+' .individual_div').show();
                $('#'+borId+' .for_both').removeClass('medium-12');
                $('#'+borId+' .for_border').addClass('border-right');
                $('#'+borId+' .for_both').addClass('medium-6');
                $('#'+borId+' .personal_info').show();
                $('#'+borId+' .borrower_bio').insertAfter('#'+borId+' .business_info');
              }
              else if(this_val=="Company or Trust")
              {
                $('#'+borId+' .business_info').show();
                $('#'+borId+' .business_financials').show();
                $('#'+borId+' .guarantor_info').show();
                $('#'+borId+' .individual_div').hide();
                $('#'+borId+' .for_both').removeClass('border-right');
                $('#'+borId+' .for_both').removeClass('medium-6');
                $('#'+borId+' .for_both').addClass('medium-12');
                $('#'+borId+' .business_info').insertAfter('#'+borId+' .one_div');
                $('#'+borId+' .personal_info').hide();
              }
            }
            /******************* Borrower Type *********************/

            /******************* Guarantor Functionality ****************/

            if(field_name=="borrower_guarantor")
            {
              if(this_val=="Yes")
              {
                $('#'+borId+' .guarantor_info').hide();
              }
              else
              {
                $('#'+borId+' .guarantor_info').show();
              }
            }

            /******************* End Guarantor Functionality ****************/
            
            if(field_name == "personal_monthly_income" || field_name == "net_worth" || field_name == "personal_gross" || field_name == "personal_cashContribution" || field_name == "cash_on_hand" || field_name == "available_credit" || field_name == "monthly_noi" || field_name == "annual_noi" || field_name == "account_recievable" || field_name == "account_payable" || field_name=="guarantor_net_worth" || field_name=="guarantor_monthly_income")
            {
              data = "&field="+field_name+"&value="+this_val+"&borrower_id="+id;
              // alert(data);
              $.ajax({
                    data: data,
                    type: 'POST',
                    url: '/loans/save_borrower_money',
                    success:function(response){
                      $("#"+field_name+"_"+id).val(response);
                    }
                });
            }
            else
            {
               data = "&field="+field_name+"&value="+this_val+"&borrower_id="+id;
                // alert(data);
                $.ajax({
                      data: data,
                      type: 'POST',
                      url: '/loans/save_borrower_field',
                      success:function(response){
                      }
                  });
            }
           


         });
        

      /************************** End Save Borrower Data ***********************************/


     $('.add_more_fund').click(function(){
        var div = $('table[class^=table-use-fund] tr:last');
        var num = parseInt( div.prop("id").match(/\d+/g), 10 ) +1;
        clon = div.clone('true').prop('id', num+"_fund" );
        clon.find('.maturityDates').hide();
        clon.find('.contractDates').hide();
        clon.find('input:text').val('');
        clon.find('input:hidden').val('');
        clon.find('.payoff_funds').hide();
        clon.find('.purchase_funds').hide();
        $('.table-use-fund').append(clon);
      });

      $('.use').change(function(){
        this_val = $(this).val();
        mainId = $(this).closest('tr').attr('id');
        

        if(this_val=="Payoff")
        {
          $('#'+mainId+' .payoff_funds').show();
          $('#'+mainId+' .purchase_funds').hide();
        }
        else if(this_val=="Purchase")
        {
          $('#'+mainId+' .purchase_funds').show();
          $('#'+mainId+' .payoff_funds').hide();
        }
        else
        {
          $('#'+mainId+' .purchase_funds').hide();  
          $('#'+mainId+' .payoff_funds').hide();
        }
      });  


      $('#save_use_funds').click(function(){
        form_data = $('#all_funds_form').serialize();
        // alert(form_data);
        data = form_data+"&loan_id=<%= @loan.id%>";
        $.ajax({
                data: data,
                type: 'POST',
                url: '/loans/add_loan_funds',
                success:function(response){
                  alert("Use of funds saved successfuly.");
                }
            });
      });

      /**************** Expand the textbox width *********************/
      // $('#loc_address').focus(function()
      // {
          /*to make this flexible, I'm storing the current width in an attribute*/
      //     $(this).attr('data-default', $(this).width());
      //     $(this).animate({ width: 250 }, 'slow');
      // }).blur(function()
      // {
          /* lookup the original width */
      //     var w = "107px";
      //     $(this).animate({ width: w }, 'slow');
      // });
      /**************** Expand the textbox width *********************/

      /**************** Remove Fund **********************************/

      $('.remove_funds').click(function(){
        rmvId = $(this).closest('.fund_row').attr('id');
        $('#'+rmvId).remove();
      });


      /**************** Remove Fund End*******************************/

      $('.tii-controls a').attr('tabindex', '-1');
      $('.tii-controls img').attr('tabindex', '-1');
      $('.cwb-controls img').attr('tabindex', '-1');
      $('.cwb-controls a').attr('tabindex', '-1');
      $('a').attr('tabindex', '-1');
      $('img').attr('tabindex', '-1');
      $('strong').attr('tabindex', '-1');
      $('.trans-info-item').attr('tabindex', '-1');
      $('.trans-info-last').attr('tabindex', '-1');


      $('input, textarea, select, div').focus(function(){
        $('.tii-controls a').attr('tabindex', '-1');
        $('.tii-controls img').attr('tabindex', '-1');
        $('.cwb-controls img').attr('tabindex', '-1');
        $('.cwb-controls a').attr('tabindex', '-1');
        $('a').attr('tabindex', '-1');
        $('img').attr('tabindex', '-1');
        $('strong').attr('tabindex', '-1');
        $('.trans-info-item').attr('tabindex', '-1');
        $('.trans-info-last').attr('tabindex', '-1');
        $('label').attr('tabindex', '-1');
       });



      $('li a').click(function(){
        $('.tii-controls a').attr('tabindex', '-1');
        $('.tii-controls img').attr('tabindex', '-1');
        $('.cwb-controls img').attr('tabindex', '-1');
        $('.cwb-controls a').attr('tabindex', '-1');
        $('a').attr('tabindex', '-1');
        $('img').attr('tabindex', '-1');
        $('strong').attr('tabindex', '-1');
        $('.trans-info-item').attr('tabindex', '-1');
        $('.trans-info-last').attr('tabindex', '-1');
        $('label').attr('tabindex', '-1');
       });

      $('#send_form_link').click(function(){
        var emails = $('#form_email').val();
        if(emails=="")
        {
          alert("Please enter email address");
        }
        else
        {
          var loan_id = "<%= @loan.id %>"
          data = "loan_id=<%= @loan.id%>&emails="+emails;
          $.ajax({
                  data: data,
                  type: 'POST',
                  url: '/loans/send_form_link',
                  success:function(response){
                    alert(response);
                    $('#myModal6').foundation('reveal', 'close');
                  }
              });
        }

        
      });  

    });
    
    function send_form_link()
    {
      $('#myModal6').foundation('reveal', 'open');
    }

</script>
<!--------------------------- End New Design -------------------------->